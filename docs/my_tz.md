
# Task 1
Необходимо создать паралельную сущность CompanyBase, задача которой существовать паралельно с Company, но в CompanyBase будут попадать данные из общих источников (парсинг и т.п.).
  id          Int      @id @default(autoincrement())
  fullName
shortName
status
country и т.д. - смотри справку по данным, которые будут парситься ниже @egr-api.md
email
site

В сущность Company необходимо добавить поля
address и city (в адресе будет дублироваться город, но в этом ничего страшного).

В CourtCase добавить необязательное поле triedToParse

Во избежание ошибок поля выше делай необязательными.

В сущности contactperson необходимо добавить необязательное поле source, которое при парсинге в данном случае заполняется как ЕГР.
В сущностях smstemplate emailtemplate необходимо добавить channelcategory, а также создать саму сущность channelСategory.


При необходимости добавь новые поля в edit detail index nuxt-app\app\pages\panel

# Task 2
Теперь реализуем поиск по части имени

Смотри справку по функции @egr-api.md

Обрати внимание, что запрос обрабатывается долго, если сервер недоступен, то очередь прекращается, выводится flash-message (если окно запуска еще открыто).

Из этого запроса в сущность companyBase сохраняются фирмернное наименование "vfn", УНП (ngrn), Статус vnsostk, полное наименование vnaim, короткое наименование vn и одновременно сохраняются данные в сущность Company краткое наименование в name, остальные имена в массив aliases. 

При успешном ответе сервера (независимо  от результативности следующей задачи) в triedToParse CourtClaim писать true.

Если найдена 1 сущность, то сущность из CourtCase (debtorCompany или claimantCompany ) связывается с этой компанией и выполняется следующий запрос поиск контактнтых данных getAddressByRegNum (справка по api @egr-api.md, #Поиск по УНП контактных данных, https://egr.gov.by/api/v2/egr/getAddressByRegNum/{regNum})

Если в court-cases сохраняется новое debtorId company, то наименование должника из court-cases добавляется в aliases для компаний.

Особенности для внедрения - ngrn = {regNum}  - это уникальное поле
Данные адреса необходимо составить в одну строку, например, для примера ниже
220007, Минск, Фабрициуса, 7-12.

Телефон для CompanyBase оставлять как есть, а для Company необходимо создать ContactPerson с именем "Общий", телефон прикреплять в связанные сущности Phone, Email, телефон преобразовать в формат 375447022404 (убрать плюс, пробелы, скобки, если несколько телефонов через запятую - создать несколько Phone), сайт сохранять как есть и в CompanyBase и в model Company (сюда в схему добавить такое свойство).

Если данные есть, то  то в таблице CompanyBase обновляются, а в Phone Email (если эти поля изменились), добавляется новая сущность ContactPerson, а ранее существовавший ContactPerson со значением "Общий" меняется флаг isDeleted.


Создай  здесь @nuxt-app\app\pages\panel\egr отдельные внутренние api-эндпоинт с доступом только из других эндпоинтов (при необходимости создай nuxt-app\app\middleware)

# Task 3
На @nuxt-app\app\pages\panel\court-cases\index.vue под названием компании необходимо выводить унп соотнесенной компании, а если компаний нет, то красным писать Не найдена. 

На @nuxt-app\app\pages\panel\court-cases\[id]\edit.vue поиск в базе необходимо производить только после ввода не менее 4 чисел или цифр по унп, названию. В поиске выводить название, унп,первые 20 букв адреса.

# Task 4
На странице @nuxt-app\app\pages\panel\court-cases\[id]\edit.vue рядом с кнопкой подробнее для debtorCompany и caseNumber  сделай кнопку поиск по УНП, которая заполняется, только если компания не заполнена). При нажатии на эту кнопку во всплывающем окне появляется окно ввода УНП (9 цифр с валидацией) и кнопка найти. При клике на эту кнопку обращается к api (его необходимо создать), который в свою очередь обращается к внутреннему api-эндпоинту, созданному в задаче 2 и выполняет эти действия. По выполнении действия - flash-message (найдено или ошибка), а если найдена одна компания - соотнести ее и выполнить задачи из пункта 2.


# Task 5
На странице @nuxt-app\app\pages\panel\court-cases\index.vue необходимо добавить кнопку поиск ответчиков, а также создать бэкэнд api для этой задачи, кнопка отображается спинером, пока работает задача.

Т.к. задача трудоемкая, то должен возвращаться ответ с предложением вернуться на страницу минут через 5 и задача будет выполняться это время в фоне.
Парсинг по API с задержкой 1 секунда.
Поиск осуществляется в отношении сущностей, отображенных на странице, только в отношении поиска debtorCompany, обрати внимание, что в других CourtCase уже мог быть этот debtorCompany. Алгоритм поиска записан в разделе 2 плана внедрения.

Если 2 раза сервер не смог отдать данные, то возвращается ошибка, поиск прекращается.

Точно также в каждой строке добавь кнопку поиск сторон, но при клике на нее поиск должен осуществляться как для debtorCompany, так и claimantCompany, во flash-message должно появляеться сообщение о найденной информации.


# Task 6
Создай новую сущность messageChain, которая будет включать в себя цепочки для emailtemplate и для smstemplate, продумай сам схему. Продумай схему, т.к. пользователю необходимо будет иметь возможность выбирать несколько emailtamplate или smstemplate, указывать дни направления от даты создания (+2 дня, + 5 дней, + 10 дней)

Необходимо создать crud для emailtemplate smstemplate messageChain без пагинации (см. crud - app/pages api/panel для других сущностей, можешь на примере @nuxt-app\app\pages\panel\users).

В email template необходимо добавить формат шаблона (будет html или plaintext)

Продумай отрисовку шаблонов для email - должны быть два варианта - с переключением табами (html или plaintext). Для двух случаев справа должно быть поле для редактирования, слева - его предпросмотр для пользователя. В окне для редактирования html дополнительный редактор не нужен. Продумай здесь все хорошо.

Добавь сущности в меню nuxt-app\app\layouts\admin.vue, при этом сделай вкладку настройки, подвкладку шаблоны, должны разворачиваться.

#  Task 7

Доработай сущности SentEmail SentSms добавь 
  externalId  String?
  status
  channel

  Сделай сокращенный crud index page и detail для сущностей SentSms SentEmail (2 разных сущности и круда) по аналогии с nuxt-app\app\pages\panel\companies\index.vue с пагинацией, а также страницу nuxt-app\app\pages\panel\companies\[id]\detail.vue.

  Добавь сущности в меню nuxt-app\app\layouts\admin.vue, при этом сделай Пункт меню Маркетинг, подпункт Рассылка и уже туда все помести.

#  Task 8
По примеру  @nuxt-app\server\utils\egr.ts сделай функции по работе с @docs\sms-api.md, @docs\email-api.md и @docs\email-yandex.md при этом в будущем отправка сообщений будет работать через BullMQ (Redis), а сохранение отправленных в текущей базе.

#  Task 9
  Данные из очереди заданий у меня будут работать через BullMQ (Redis).
  Сделай также полноценный crud для этой общей очереди, продумай структуру данных.
  Я так предполагаю, что кроме ключа при планировании отправки должен сохраняться шаблон, дата отправки, тип отправки (смс или емаил), статусы отправки, и т.п. Также должна быть возможность открыть для редактирования эти данные и изменить в нужном месте. Т.е. нужен полноценный crud nuxt-app\app\pages\panel\companies\index.vue с пагинацией как здесь nuxt-app\app\pages\panel\companies\[id]\edit.vue , а также страницу nuxt-app\app\pages\panel\companies\[id]\detail.vue

    Добавь сущности в меню nuxt-app\app\layouts\admin.vue, при этом сделай вкладку Маркетинг, подвкладку Очередь рассылки, должны разворачиваться.
  
# Task 10

Теперь давай поработаем с nuxt-app\app\pages\panel\court-cases\index.vue
Если есть связанная компания (debtorId, claimantId), то нужно добавлять не только наименование, но и краткие данные всех contactPerson с привязанными phone, email.

т.е. будет строка вида 1) Общий (или иное имя) - Емаилы, Телефоны, при этом рядом с каждым именем contactPerson, телефоном или емаил должна быть маленькая иконка редактирования, по которому открывается небольшое окно рядом (absolute) с кнопкой сохранить. Для этого нужно переделать и эндпоинты, возможно, для сохранения создать новые.

Необходимо добавить в courtCase строку proceeded true.

Необходимо добавить фильтр не показывать отработанные (toggle)

Необходимо в меню еще добавить кнопку пометить отработанным и направлять запрос в БД без перезагрузки системы, при этом при активности кнопки отработанные элемент должен красиво уходить из системы.

Необходимо добавить возможность выделения строки, при этом при наличии таких выделений должны появляться кнопки совершения действий для ряда строк - поиск должника в ЕГР, поиск сторон в ЕГР.

# Task 11
http://localhost:3000/panel/court-cases/9/detail
http://localhost:3000/panel/court-cases/9/edit
Вот здесь на этой странице необходимо внедрить следующее:
на этой странице есть функции http://localhost:3000/panel/court-cases - поиск Ответчика в ЕГР, поиск сторон в ЕГР. Внедри эти кнопки и функционал.


# Task 12

http://localhost:3000/panel/court-cases/9/detail
На этой странице
для каждой сущности Ответчик и Должник нужно отредактировать отображение связанной компании
Связанную компанию лучше всего отображать через компонент, чтобы не дублировать код.
В частности, должно отображаться Подробнее, Редактировать кнопки.
Перечень контактов в формате таком:
т.е. будет строка вида Номер позиции Общий (или иное имя) - Емаилы, Телефоны, при этом рядом с каждым именем contactPerson, телефоном или емаил должна быть маленькая иконка редактирования, по которому открывается небольшое окно рядом (absolute) с кнопкой сохранить. Для этого нужно переделать и эндпоинты, возможно, для сохранения создать новые.

Кроме того, должна быть кнопка "Быстрая задача" - открывается во вслывающем окне с возможностью сохранения
Также "Зарегистрировать звонок" с выбором и привязкой сущностей (телефон и т.п.)
Отправить письмо, Отправить sms, запланировать цепочку. Функционал при клике на эти кнопки должен открываться во всплывающем окне, должны быть предусмотрены api запросы для них.


При отправке смс - смс отправляется сразу.
При отправке письма - необходимо получать из редис и искать первое возможное время для отправки, которое определяется следующем образом: смотрим первое сообщение на сегодня, если в течение 5 минут после него запланировано следующее, то берем следующее и опять так смотрим + 5 минут, но не ранее 09.00 утра.
Если запланировать цепочку, то планируем смс и емаил. Емаил планируем также, как и выше (на дни вперед планируем с 09.00 утра и дальше), смс для цепочек тоже +1 минута с 10.00.
